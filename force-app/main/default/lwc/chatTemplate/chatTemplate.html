<template>
    <div lwc:if={isCheckMember} class="layout slds-card">
        <div class="layout-header">
            
        </div>
        <div class="layout-body">
            <div class="chat-container" tabindex="0" onfocus={handleChatFocus} onblur={handleChatBlur}>
                <div class="chat-header">
                    <div class="chat-info-container">
                        <h2>{info.name}</h2>
                    </div>
                    <div class="user-info-container">
                        <div class="chatting-out-button" onclick={handleExitClick}>
                            <lightning-icon icon-name="utility:outcome" size="small" alternative-text="채팅방 나가기" title="채팅방 나가기"></lightning-icon>
                        </div>
                        <div class="user-profile">
                            <div><img class="user-profile-photo" src={info.photoUrl} /></div>
                            <div><span>{info.userName}</span></div>
                        </div>
                        <div class="member-info" onclick={handleMemberClick}>
                            <div><lightning-icon icon-name="utility:user" size="small" alternative-text="채팅 맴버 보기" title="채팅 맴버 보기"></lightning-icon></div>
                            <div><span>{info.totalMemberCount}</span></div>
                        </div>
                    </div>
                </div>
                <div class="chat-body">
                    <div lwc:if={isShowPreview} class="image-modal-container" >
                        <div lwc:if={isFileSending}>
                            <lightning-spinner alternative-text="Loading" size="x-small"></lightning-spinner>
                        </div>
                        <div class="image-modal">
                            <div class="modal-header">
                                <div class="file-name">
                                    <h2>{fileName}</h2>
                                </div>
                            </div>
                            <div class="modal-body">
                                <div class="file-preview">
                                    <img lwc:if={isImg} src={fileUrl} />
                                    <video lwc:else src={fileUrl} ></video>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="slds-button" disabled={isFileSending} onclick={handleClosePreview}>닫기</button>
                                <button class="slds-button" disabled={isFileSending} onclick={handleFileSubmit}>전송</button>
                            </div>
                        </div>
                        <div class="image-modal-background"></div>
                    </div>
                    <div class="member-list-container"> <!-- lwc:if={isShowMembers}  -->
                        <template lwc:if={isSearchUser} >
                            <div class="list-header">
                                <div class="user-search-container">
                                    <lightning-input variant="label-hidden" type="search" class="user-search-input" onkeyup={handleSearchKeyup} ></lightning-input>
                                </div>
                                <div class="add-button" onclick={handleAddButtonClick}>
                                    <lightning-icon icon-name="utility:close" size="small" alternative-text="user" title="user"></lightning-icon>
                                </div>
                            </div>
                            <div class="list-body">
                                <template for:each={searchUsers} for:item="mem" for:index="idx">
                                    <div key={mem.recordId} class="list-item-container search-uesr-item" data-recordid={mem.recordId} onclick={handleSelectUser}>
                                        <div class="profile"><img class="user-profile-photo" src={mem.photoUrl} /></div>
                                        <div class="name">{mem.name}</div>
                                        <div class="button-container"></div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template lwc:else >
                            <div class="list-header">
                                <div class="list-header-text">
                                    <h2>대화 상대 목록</h2>
                                </div>
                                <div class="add-button" onclick={handleAddButtonClick}>
                                    <lightning-icon icon-name="utility:adduser" size="small" alternative-text="채팅방 초대" title="채팅방 초대"></lightning-icon>
                                </div>
                            </div>
                            <div class="list-body">
                                <template for:each={info.members} for:item="mem" for:index="idx">
                                    <div key={mem.recordId} class="list-item-container" data-recordid={mem.recordId} onmousedown={handleContext}>
                                        <div class="profile"><img class="user-profile-photo" src={mem.photoUrl} /></div>
                                        <div class="name">{mem.name}</div>
                                        <div class="button-container">
                                            <ul class="hide" onmouseenter={handleContextmenuEnter} onmouseleave={handleContextmenuLeave}>
                                                <template lwc:if={isNotMe}>
                                                    <li lwc:if={isMyRoom} onclick={handleExit}>내보내기</li>
                                                    <li onclick={handleDirectChat}>1:1 채팅하기</li>
                                                </template>
                                            </ul>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                    <div class="content-container">
                        <div class="content">
                            <div lwc:if={isLoading} class="alert-content">채팅을 가져오는 중입니다...</div>
                            <div lwc:if={hasNotContents} class="alert-content">채팅 내역이 없습니다...</div>
                        </div>
                        <template for:each={contents} for:item="content" for:index="idx" >
                            <div lwc:if={content.isMyMessage} class="content fRight" key={content.key}>
                                <div class="member-photo"><img src={content.photoUrl}/></div>
                                <div class="content-text">
                                    <div class="name">{content.name}</div>
                                    <div class="text">
                                        <template lwc:if={content.isImg} >
                                            <img src={content.message} />
                                        </template>
                                        <template lwc:else >
                                            <pre>{content.message}</pre>
                                        </template>
                                    </div>
                                    <div class="time">{content.HHmm}</div>
                                </div>
                            </div>
                            <div lwc:elseif={content.isNotification} class="content" key={content.key}>
                                <div class="alert-content">{content.message}</div>
                            </div>
                            <div lwc:else class="content" key={content.key}>
                                <div class="member-photo"><img src={content.photoUrl}/></div>
                                <div class="content-text">
                                    <div class="name">{content.name}</div>
                                    <div class="text">
                                        <template lwc:if={content.isImg} >
                                            <img src={content.message} />
                                        </template>
                                        <template lwc:else >
                                            <pre>{content.message}</pre>
                                        </template>
                                    </div>
                                    <div class="time">{content.HHmm}</div>
                                </div>
                            </div>
                        </template>
                        <div lwc:if={isSending} class="content fRight">
                            <div class="member-photo"><img src={info.photoUrl}/></div>
                            <div class="content-text">
                                <div class="name">{messageModel.name}</div>
                                <div class="text">{messageModel.message}</div>
                                <div class="time">{messageModel.HHmm}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chat-footer">
                    <template lwc:if={isSearchUser} >
                        <div class="select-user-container">
                            <lightning-pill-container items={selectUsers} onitemremove={handleItemRemove}></lightning-pill-container>
                        </div>
                        <div class="submit-button" onclick={handleInvite}>초대하기</div>
                    </template>
                    <template lwc:else >
                        <div class="input-container">
                            <textarea placeholder="메세지를 입력해주세요..."
                                      class="message-input"
                                      onfocus={handleChatFocus}
                                      onblur={handleChatBlur}
                                      onkeyup={handleKeyup}
                                      onpaste={handlePaste}>
                            </textarea>
                        </div>
                        <div class="submit-button" onclick={handleClick}>보내기</div>
                    </template>
                </div>
            </div>
        </div>
        <div class="layout-footer">
    
        </div>
    </div>
</template>